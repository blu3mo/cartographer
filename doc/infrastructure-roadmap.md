# インフラ & デプロイ ロードマップ

このドキュメントでは、システムのポータビリティ、セキュリティ、および保守性を向上させるための将来的な改善計画を管理します。

---

## 1. 秘匿情報の管理 (Secret Management)

現在、アプリケーションの環境変数（`.env`）や SSL 証明書は、デプロイを実行するマシンのローカルファイルとして管理され、Colmena の `deployment.keys` 機能を通じてターゲットサーバーに転送されています。

### 短期的な対策
- **現状**: `flake.nix` 内で環境変数（`$PWD`）を利用してパスを組み立て、実行時に `--impure` を付与することで、特定の絶対パスへの依存を排除しています。
- **セキュリティの担保**: 秘密情報そのものを Nix Store (`/nix/store`) にコピーさせないため、あえて不純な (`impure`) パス解決を採用しています。

### 中長期的な計画
1.  **フェーズ1: 秘匿情報の暗号化 (agenix / sops-nix)**
    - `.env` ファイルや証明書を `age` や `pgp` で暗号化した状態でリポジトリにコミットします。
    - サーバーの SSH 鍵を用いてデプロイ時に動的に復号する仕組みを導入し、リポジトリをクローンすれば誰でも（権限があれば）デプロイ可能な状態を目指します。

2.  **フェーズ2: 外部シークレットマネージャーの活用 (AWS Secrets Manager)**
    - 本番環境については、AWS Secrets Manager 等のマネージドサービスでの管理に移行します。
    - アプリケーション起動時に AWS SDK を通じてシークレットを取得し、ディスクへの書き出しを最小限に抑えます。

---

## 2. ストレージ連携の高度化 (EFS Access Point)

現在の `application.nix` で行っている `ExecStartPre` による `chown` は、より AWS ネイティブな手法へ移行可能です。

### EFS Access Point への移行
1.  **仕組み**: AWS 側の Access Point 設定で POSIX ユーザー (UID:1000) を指定します。
2.  **メリット**: 
    - マウントポイントの権限が AWS 側で強制されるため、サーバー上での `chown`（root権限の行使）が不要になります。
    - ディレクトリの自動作成機能などが利用でき、より堅牢なインフラ構成になります。
3.  **要件**:
    - NixOS への `amazon-efs-utils` の導入。
    - `fileSystems` 設定における `accesspoint` オプションの指定。

---

## 3. 継続的デプロイ (CI/CD)

- **GitHub Actions 連携**: 
    - 特定のブランチへの push をトリガーに、GitHub Actions から `colmena apply` を実行する仕組みを検討します。
    - この際、OIDC を用いた AWS 認証と、暗号化された秘密情報の安全な取り扱いが前提となります。
